class DetailsDisclosure extends HTMLElement {
  constructor() {
    super();

    // Check if the element exists before proceeding
    const mainDetailsToggle = this.querySelector('details');
    // if (!mainDetailsToggle) {
    //   console.error('No <details> element found within DetailsDisclosure');
    //   return;
    // }

    this.mainDetailsToggle = mainDetailsToggle;

    this.addEventListener('keyup', this.onKeyUpEscape.bind(this));
    this.mainDetailsToggle.addEventListener('focusout', this.onFocusOut.bind(this));
    
    // Initialize a debounce timer
    this.debounceTimer = null;
  }

  onKeyUpEscape(event) {
    if (event.key === 'Escape') {
      this.close();
    }
  }

  onFocusOut() {
    // Use a debounce to prevent multiple rapid executions
    clearTimeout(this.debounceTimer);
    this.debounceTimer = setTimeout(() => {
      if (!this.contains(document.activeElement)) {
        this.close();
      }
    }, 200); // Adjust the debounce time as needed
  }

  close() {
    this.mainDetailsToggle.removeAttribute('open');
  }
}

customElements.define('details-disclosure', DetailsDisclosure);
